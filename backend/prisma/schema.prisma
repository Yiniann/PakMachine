generator client {
  provider = "prisma-client-js"
  // Include linux engine so Prisma Client works on debian hosts deployed with mac-built artifacts
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int       @id @default(autoincrement())
  email              String    @unique
  password           String
  role               String    @default("user") // "user" | "admin"
  siteName           String?
  buildQuotaUsed     Int       @default(0) // 当天已使用的构建次数
  buildQuotaDate     DateTime?
  resetToken         String?
  resetTokenExpires  DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // 打包相关关联
  buildJobs           BuildJob[]
  buildProfile        BuildProfile?
  buildArtifacts      BuildArtifact[]
}

/// 管理员上传的模板（一个 zip 文件）
model Template {
  id          Int      @id @default(autoincrement())
  name        String           // 模板名称
  description String?          // 模板描述
  filePath    String           // 模板 zip 在服务器上的路径
  envSchema   String?          // JSON: ["VITE_API_URL","VITE_TITLE", ...]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
}

/// 每一次打包任务（独立 env + 独立产物文件）
model BuildJob {
  id           Int      @id @default(autoincrement())
  userId       Int
  filename     String
  status       String   // "pending" | "running" | "success" | "failed"
  envJson      String   @db.LongText // 本次打包使用的 env 快照 JSON
  artifactId   Int?
  message      String?  @db.Text // 构建日志 / 错误信息（可选）
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

/// 用户常用的构建配置（站点信息、IDHub、客户端下载链接等）
model BuildProfile {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

/// 构建产物元数据，用于绑定下载权限
model BuildArtifact {
  id             Int      @id @default(autoincrement())
  userId         Int
  sourceFilename String
  outputPath     String
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}
