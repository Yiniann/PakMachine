generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int       @id @default(autoincrement())
  email              String    @unique
  password           String
  role               String    @default("user") // "user" | "admin"
  resetToken         String?
  resetTokenExpires  DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // 打包相关关联
  buildJobs           BuildJob[]
  userTemplateConfigs UserTemplateConfig[]
  buildProfile        BuildProfile?
  buildArtifacts      BuildArtifact[]
}

/// 管理员上传的模板（一个 zip 文件）
model Template {
  id          Int      @id @default(autoincrement())
  name        String           // 模板名称
  description String?          // 模板描述
  filePath    String           // 模板 zip 在服务器上的路径
  envSchema   String?          // JSON: ["VITE_API_URL","VITE_TITLE", ...]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  buildJobs           BuildJob[]
  userTemplateConfigs UserTemplateConfig[]
}

/// 某个用户对某个模板的一份“当前 env 配置”（用于下次自动带出）
model UserTemplateConfig {
  id         Int      @id @default(autoincrement())
  userId     Int
  templateId Int
  envJson    String   // JSON: {"VITE_API_URL":"...","VITE_TITLE":"..."}

  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  template Template @relation(fields: [templateId], references: [id])

  @@unique([userId, templateId])
}

/// 每一次打包任务（独立 env + 独立产物文件）
model BuildJob {
  id           Int      @id @default(autoincrement())
  userId       Int
  templateId   Int
  status       String   // "pending" | "running" | "success" | "failed"
  envJson      String   // 本次打包使用的 env 快照 JSON
  artifactPath String?  // 构建出来的 zip 文件路径
  log          String?  // 构建日志 / 错误信息（可选）
  createdAt    DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  template Template @relation(fields: [templateId], references: [id])
}

/// 用户常用的构建配置（站点信息、IDHub、客户端下载链接等）
model BuildProfile {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

/// 构建产物元数据，用于绑定下载权限
model BuildArtifact {
  id             Int      @id @default(autoincrement())
  userId         Int
  sourceFilename String
  outputPath     String
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}
