name: Build Template

on:
  workflow_dispatch:
    inputs:
      jobId:
        description: "Backend job id"
        required: true
        type: string
      envJson:
        description: "Env content as string"
        required: true
        type: string
      workdir:
        description: "Optional subdirectory"
        required: false
        type: string

env:
  BACKEND_WEBHOOK_URL: ${{ vars.BACKEND_WEBHOOK_URL || 'https://pac.xiamii.com/webhooks/github' }}
  CF_R2_ACCOUNT_ID: ${{ secrets.CF_R2_ACCOUNT_ID || '' }}
  CF_R2_ACCESS_KEY_ID: ${{ secrets.CF_R2_ACCESS_KEY_ID || '' }}
  CF_R2_SECRET_ACCESS_KEY: ${{ secrets.CF_R2_SECRET_ACCESS_KEY || '' }}
  CF_R2_BUCKET: ${{ secrets.CF_R2_BUCKET || '' }}
  CF_R2_PUBLIC_BASE: ${{ secrets.CF_R2_PUBLIC_BASE || '' }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set workdir
        run: echo "WORKDIR=${{ github.event.inputs.workdir || '.' }}" >> $GITHUB_ENV

      - name: Write .env
        run: |
          cd "$WORKDIR"
          printf '%s' "${{ github.event.inputs.envJson }}" > .env

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false

      - name: Install & build
        run: |
          cd "$WORKDIR"
          pnpm install --no-frozen-lockfile
          pnpm run build

      - name: Package artifact
        run: |
          set -euo pipefail
          # Look for build output in several common locations and package the first match.
          targets="$GITHUB_WORKSPACE/$WORKDIR/dist
          $GITHUB_WORKSPACE/$WORKDIR/build
          $GITHUB_WORKSPACE/frontend/dist
          $GITHUB_WORKSPACE/frontend/build
          $GITHUB_WORKSPACE/backend/dist
          $GITHUB_WORKSPACE/backend/build"

          target=""
          for p in $targets; do
            if [ -d "$p" ]; then
              target="$p"
              break
            fi
          done
          if [ -z "$target" ]; then
            echo "No dist/build directory found among candidates."
            exit 1
          fi
          # Create artifact in workspace root so upload step can find it reliably
          cd "$(dirname "$target")"
          zip -r "$GITHUB_WORKSPACE/artifact.zip" "$(basename "$target")"

      - name: Notify running
        run: |
          body='{"jobId":"${{ github.event.inputs.jobId }}","status":"running","message":"GitHub Actions 构建中"}'
          sig="sha256=$(echo -n "$body" | openssl dgst -sha256 -hmac "${{ secrets.ACTION_WEBHOOK_SECRET }}" | cut -d' ' -f2)"
          curl -s -X POST -H "Content-Type: application/json" -H "X-Hub-Signature-256: $sig" \
            -d "$body" "$BACKEND_WEBHOOK_URL"

      - name: Upload artifact (GitHub-hosted)
        uses: actions/upload-artifact@v4
        with:
          name: built-asset
          # Use runner-provided workspace path (env.GITHUB_WORKSPACE is empty)
          path: ${{ github.workspace }}/artifact.zip

      - name: Upload artifact to Cloudflare R2 (optional)
        env:
          AWS_ACCESS_KEY_ID: ${{ env.CF_R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ env.CF_R2_SECRET_ACCESS_KEY }}
          AWS_REGION: auto
        run: |
          if [ -z "$CF_R2_ACCOUNT_ID" ] || [ -z "$CF_R2_ACCESS_KEY_ID" ] || [ -z "$CF_R2_SECRET_ACCESS_KEY" ] || [ -z "$CF_R2_BUCKET" ] || [ -z "$CF_R2_PUBLIC_BASE" ]; then
            echo "Cloudflare R2 secrets not set, skip R2 upload"
            exit 0
          fi
          set -euo pipefail
          endpoint="https://${CF_R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          key="artifact-${{ github.run_id }}.zip"
          aws s3 cp "$GITHUB_WORKSPACE/artifact.zip" "s3://$CF_R2_BUCKET/$key" --endpoint-url "$endpoint"
          echo "ARTIFACT_URL=$CF_R2_PUBLIC_BASE/$key" >> $GITHUB_ENV

      - name: Notify success
        run: |
          artifactUrl="${ARTIFACT_URL:-}"
          body='{"jobId":"${{ github.event.inputs.jobId }}","status":"success","message":"构建完成","artifactUrl":"'"$artifactUrl"'","artifactFilename":"artifact.zip"}'
          sig="sha256=$(echo -n "$body" | openssl dgst -sha256 -hmac "${{ secrets.ACTION_WEBHOOK_SECRET }}" | cut -d' ' -f2)"
          curl -s -X POST -H "Content-Type: application/json" -H "X-Hub-Signature-256: $sig" \
            -d "$body" "$BACKEND_WEBHOOK_URL"

      - name: Notify failure
        if: failure()
        run: |
          body='{"jobId":"${{ github.event.inputs.jobId }}","status":"failed","message":"GitHub Actions 构建失败"}'
          sig="sha256=$(echo -n "$body" | openssl dgst -sha256 -hmac "${{ secrets.ACTION_WEBHOOK_SECRET }}" | cut -d' ' -f2)"
          curl -s -X POST -H "Content-Type: application/json" -H "X-Hub-Signature-256: $sig" \
            -d "$body" "$BACKEND_WEBHOOK_URL"
